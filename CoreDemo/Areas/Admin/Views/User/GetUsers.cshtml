@{
    ViewBag.Title = @ViewLocalizer["Title"];
    Layout = "_AdminLayout";
}

<h2>@ViewLocalizer["PageTitle"]</h2>
<br />

<button type="button" id="btnGetUsers" class="btn btn-primary">@ViewLocalizer["ListUsers"]</button>
<button type="button" id="btnShowUserIdText"
        class="btn btn-primary">
    @ViewLocalizer["ListUsersByUsername"]
</button>
<br />
<br />

<div id="userList">
    <label class="mt-2">
        @ViewLocalizer["ListAreaInfoText"]
    </label>
</div>

<div id="userIdDiv" style="display: none; ">
    <input type="text"
           id="userUsernameText"
           placeholder="@ViewLocalizer["EnterUsername"]"
           class="form-control border border-dark mb-2"
           style="width: 200px" />
    <button type="button" id="btnGetUser"
            class="btn btn-primary">
        @ViewLocalizer["ListButtonText"]
    </button>
</div>


@section scripts{
    <script>

        window.onload = function () {
        @Html.Raw(TempData["Message"])
                        }

        toastr.options.progressBar = true;
        toastr.options.positionClass = "toast-bottom-right";

        GetUsers = function () {
            var users = {};

            $.ajax({
                async: false,
                contentType: "application/json",
                dataType: "json",
                type: "GET",
                url: "/Admin/User/GetUsersJson",
                success: function (data) {
                    users = jQuery.parseJSON(data);
                }
            });

            return users;
        }

        GetUsersByUsername = function (username) {
            var foundUser = {};

            $.ajax({
                async: false,
                contentType: "application/json",
                dataType: "json",
                type: "GET",
                url: "/Admin/User/GetUsersByUsernameJson?username=" + username,
                success: function (data) {
                    foundUser = jQuery.parseJSON(data);
                }
            });

            return foundUser;
        }

        LoadToTableGetUsers = function () {

            var users = GetUsers();

            var tableHTML =
                "<table class='table table-bordered'>" +
                "<tr> " +
                "<th> @ViewLocalizer["UserNameSurname"] </td>" +
                "<th> @ViewLocalizer["UserUsername"] </td>" +
                "<th> @ViewLocalizer["UserState"] </td>" +
                "<th> @ViewLocalizer["UserProcesses"] </td>" +

                "</tr>";
            for (var i = 0; i < users.length; i++) {
                tableHTML += "<tr>";
                tableHTML += "<td>" + users[i].NameSurname + "</td>";
                tableHTML += "<td>" + users[i].Username + "</td>";
                if (users[i].LockoutEnabled) {
                    tableHTML += "<td><span class='badge badge-danger'>@ViewLocalizer["Banned"]</span></td>";
                }

                else {
                    tableHTML += "<td><span class='badge badge-success'>@ViewLocalizer["Clear"]</span></td>";
                }
                tableHTML += "<td>";
                tableHTML += "<a href='/Admin/User/UpdateRolesToUser/" + users[i].Id + "' class='btn btn-success'>@ViewLocalizer["GetRolesToUser"]</a>";
                if (users[i].LockoutEnabled) {
                    
                    tableHTML += "<a onClick=RemoveBanFromUser(" + users[i].Id + ") class='btn btn-success text-white ml-2'>@ViewLocalizer["RemoveBanFromUser"]</a>";
                }

                else {
                    
                    tableHTML += "<a href=/Admin/User/BanUser/" + users[i].Id + " class='btn btn-danger ml-2'> @ViewLocalizer["BanUser"]</a>";
                }

                tableHTML += "</td> ";


                tableHTML += "</tr>";
            }

            tableHTML += "</table>";

            $("#userList").html(tableHTML);
        }

        LoadToTableGetUsersByUsername = function () {

            var username = $("#userUsernameText").val();

            if (username === "")
                toastr.error("@ViewLocalizer["EnterUsername"]");
            else {

                var users = GetUsersByUsername(username);

                if (users.length == 0) {
                    var emptyList = "<div class='alert alert-warning font-weight-bold'> @ViewLocalizer["NoUserHasBeenFoundByThisUsername"] </div>"
                    $("#userList").html(emptyList);
                }

                else {
                    var tableHTML =
                        "<table class='table table-bordered'>" +
                        "<tr> " +
                        "<th> @ViewLocalizer["UserNameSurname"] </td>" +
                        "<th> @ViewLocalizer["UserUsername"] </td>" +
                        "<th> @ViewLocalizer["UserState"] </td>" +
                        "<th> @ViewLocalizer["UserProcesses"] </td>" +
                        "</tr>";
                    for (var i = 0; i < users.length; i++) {
                        tableHTML += "<tr>";
                        tableHTML += "<td>" + users[i].NameSurname + "</td>";
                        tableHTML += "<td>" + users[i].Username + "</td>";
                        if (users[i].LockoutEnabled) {
                            tableHTML += "<td><span class='badge badge-danger'>@ViewLocalizer["Banned"]</span></td>";
                        }

                        else {
                            tableHTML += "<td><span class='badge badge-success'>@ViewLocalizer["Clear"]</span></td>";
                        }
                        tableHTML += "<td>";
                        tableHTML += "<a href='/Admin/User/UpdateRolesToUser/" + users[i].Id + "' class='btn btn-success'>@ViewLocalizer["GetRolesToUser"]</a>";
                        if (users[i].LockoutEnabled) {

                            tableHTML += "<a onClick=RemoveBanFromUser(" + users[i].Id + ") class='btn btn-success text-white ml-2'>@ViewLocalizer["RemoveBanFromUser"]</a>";
                        }

                        else {

                            tableHTML += "<a href=/Admin/User/BanUser/" + users[i].Id + " class='btn btn-danger ml-2'> @ViewLocalizer["BanUser"]</a>";
                        }


                        tableHTML += "</tr>";
                    }

                    tableHTML += "</table>";

                    $("#userList").html(tableHTML);
                }



            }


        }


        function RemoveBanFromUser(id) {
            swal("@ViewLocalizer["VerifyRemovingBanFromUser"]", {
                buttons: {
                    yes: {
                        text: "@ViewLocalizer["Yes"]",
                        value: "true",
                    },
                    no: {
                        text: "@ViewLocalizer["No"]",
                        value: "false",
                    },
                },
            })
                .then(async (value) => {

                    switch (value) {
                        case "true":
                            toastr.success("@ViewLocalizer["UserBanSuccessfullyRemoved"]", "", {
                                "positionClass": "toast-bottom-right"
                            });
                            //Just like Thread.Sleep
                            await new Promise(resolve => setTimeout(resolve, 3000));
                            window.location.href = "/Admin/User/RemoveBanFromUser?id=" + id
                            break;
                        case "false":
                            break;
                    }
                });
        }

        $("#btnShowUserIdText").click(function () {


            document.getElementById("userList").innerHTML = "<label class='mt-2'>@ViewLocalizer["ListAreaInfoText"]</label>";

            var div = document.getElementById("userIdDiv");

            if (div.style.display === "block") {
                div.style.display = "none";
            } else {

                div.style.display = "block";
            }


        });

        $("#btnGetUsers").click(function () {

            document.getElementById("userList").innerHTML = "";

            var element = document.getElementById("userIdDiv");
            element.style.display = "none";
            LoadToTableGetUsers();
        });

        $("#btnGetUser").click(function () {
            LoadToTableGetUsersByUsername();
        });


    </script>
}
